<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ãƒãƒƒãƒãƒ³ã‚°å¾…æ©Ÿä¸­</title>
    <link rel="stylesheet" th:href="@{/css/matchingwait.css}">
</head>
<body>
    <div class="container">
        <h1>ãƒãƒƒãƒãƒ³ã‚°ä¸­...</h1>
        <p class="status-text">ä»–ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å¾…ã£ã¦ã„ã¾ã™</p>

        <div class="player-list">
            <div class="player-slot connected" id="p1">
                <div class="icon">ğŸ‘¤</div>
                <div class="name" th:text="${session.loginName}">ãƒ¦ãƒ¼ã‚¶å</div>
            </div>
            <div class="player-slot" id="p2">
                <div class="icon">?</div>
                <div class="name">å¾…æ©Ÿä¸­...</div>
            </div>
            <div class="player-slot" id="p3">
                <div class="icon">?</div>
                <div class="name">å¾…æ©Ÿä¸­...</div>
            </div>
            <div class="player-slot" id="p4">
                <div class="icon">?</div>
                <div class="name">å¾…æ©Ÿä¸­...</div>
            </div>
        </div>

        <a th:href="@{/start}" class="cancel-btn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</a>
    </div>
    <script th:inline="javascript">
        const loginName = /*[[${session.loginName}]]*/ 'Guest';
        const mgmtIp = "192.168.11.13"; 
        const socket = new WebSocket(`ws://${mgmtIp}:8080/app/matching`);

    socket.onopen = () => {
        const msg = { taskName: "MATCHING", userName: loginName, userId: loginName };
        socket.send(JSON.stringify(msg));
    };

    socket.onmessage = (event) => {
        const data = JSON.parse(event.data);
        console.log("Received:", data);

        if (data.taskName === "WAIT_STATUS") {
            updatePanels(data.players);
        } 
        else if (data.taskName === "MATCH_FOUND") {
            console.log("Success! RoomID:", data.roomId);
            // roomIdãŒæ­£ã—ãå…¥ã£ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ã—ã¦é·ç§»
            if (data.roomId) {
                window.location.href = `/game?roomId=${data.roomId}&playerId=${loginName}`;
            }
        }
    };

    function updatePanels(players) {
        for (let i = 1; i <= 4; i++) {
            const slot = document.getElementById(`p${i}`);
            if (!slot) continue;

            const nameLabel = slot.querySelector('.name');
            const playerName = players[i - 1];

            if (playerName) {
                slot.classList.add('connected');
                nameLabel.innerText = playerName;
            } else {
                slot.classList.remove('connected');
                nameLabel.innerText = "å¾…æ©Ÿä¸­...";
            }
        }
    }
    </script>
</body>
</html>